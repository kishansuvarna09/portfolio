name: Deploy project

on:
    push:
        branches:
            - main

jobs:
    deploy:
        runs-on: ubuntu-latest
        container:
            image: node:22
        steps:
            - uses: actions/checkout@v2
              with:
                  node-version: 22

            - name: Setup SSH Key
              run: |
                  mkdir -p ~/.ssh
                  echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
                  chmod 600 ~/.ssh/id_ed25519
                  ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

            - name: Deploy using SCP
              run: scp -o StrictHostKeyChecking=no -i ~/.ssh/id_ed25519 -r . ${{secrets.SSH_USER}}@${{secrets.SSH_HOST}}:${{secrets.SSH_PATH}}

            - name: Remove old certificates and copy new ones
              run: |
                  ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_ed25519 ${{secrets.SSH_USER}}@${{secrets.SSH_HOST}} << 'EOF'
                  cd ${{secrets.SSH_PATH}} && \
                  chmod -R 777 ./* && \
                  cp -r /opt/helloworld/certbot/conf/live/itchygeek.com/* ${{secrets.SSH_PATH}}/nginx/certs/
                  EOF

            - name: Restart server
              run: |
                  ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_ed25519 ${{secrets.SSH_USER}}@${{secrets.SSH_HOST}} "
                  cd ${{secrets.SSH_PATH}} && \
                  docker-compose down && docker-compose up -d"

        post:
            - name: Cleanup
              run: |
                  ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_ed25519 ${{secrets.SSH_USER}}@${{secrets.SSH_HOST}} "
                  rm -rf ${{secrets.SSH_PATH}}/{*,.*} 2>/dev/null || true"
